<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hardware AR - Ultimate Edition</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@300;400;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #00ff88;
            --accent: #00ccff;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Inter', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI 2.0 (Glassmorphism Premium) --- */

        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            padding: 24px;
            background: var(--glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            pointer-events: none;
            z-index: 10;
            transition: opacity 0.5s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        h1 {
            margin: 0;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 28px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        .badge {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: black;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 800;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        #subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            margin-top: 8px;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        /* Doca de Sele√ß√£o */
        #selection-dock {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
            z-index: 20;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .model-btn {
            width: 60px;
            height: 60px;
            border-radius: 22px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .model-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--primary), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .model-btn.active {
            border-color: rgba(0, 255, 136, 0.5);
            color: white;
            transform: translateY(-8px);
            box-shadow: 0 10px 20px rgba(0, 255, 136, 0.15);
        }

        .model-btn.active::before {
            opacity: 0.1;
        }

        .btn-icon {
            font-size: 22px;
            margin-bottom: 2px;
            z-index: 1;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
        }

        .btn-label {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1px;
            z-index: 1;
            font-family: 'Rajdhani';
        }

        /* Guias e Loader */
        #ar-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            display: none;
            pointer-events: none;
            letter-spacing: 1px;
        }

        #loader {
            position: absolute;
            inset: 0;
            background: #020202;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loader-text {
            color: var(--primary);
            font-family: 'Rajdhani';
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 4px;
            margin-top: 20px;
            text-transform: uppercase;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 255, 136, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.8s infinite cubic-bezier(0.6, 0.2, 0.4, 0.8);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Bot√£o AR */
        button#ARButton {
            background: white !important;
            color: black !important;
            border-radius: 40px !important;
            bottom: 120px !important;
            width: 180px !important;
            height: 50px !important;
            font-family: 'Rajdhani' !important;
            font-weight: 800 !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.2) !important;
            border: none !important;
        }
    </style>
</head>

<body>

    <div id="info-panel">
        <h1>
            <span id="model-title">ASUS ROG MAXIMUS</span>
            <span class="badge">ULTIMATE</span>
        </h1>
        <div id="subtitle">HIGH-FIDELITY AR SYSTEM ‚Ä¢ REAL-TIME REFLECTIONS</div>
    </div>

    <div id="selection-dock">
        <div class="model-btn active" onclick="window.selectModel('mobo')">
            <div class="btn-icon">üéõÔ∏è</div>
            <div class="btn-label">MOBO</div>
        </div>
        <div class="model-btn" onclick="window.selectModel('cpu')">
            <div class="btn-icon">‚ùÑÔ∏è</div>
            <div class="btn-label">COOLER</div>
        </div>
        <div class="model-btn" onclick="window.selectModel('gpu')">
            <div class="btn-icon">üìº</div>
            <div class="btn-label">GPU</div>
        </div>
        <div class="model-btn" onclick="window.selectModel('ram')">
            <div class="btn-icon">üíæ</div>
            <div class="btn-label">RAM</div>
        </div>
    </div>

    <div id="ar-guide">MOVA O CELULAR LENTAMENTE...</div>

    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">Initialising System</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoundedBoxGeometry } from 'three/addons/geometries/RoundedBoxGeometry.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

        let camera, scene, renderer;
        let contentGroup, reticle;
        let hitTestSource = null, hitTestSourceRequested = false;
        let objectPlaced = false;

        let fans = [];
        let floatParts = [];
        let rgbTextureH, rgbTextureV;
        const mats = {};

        try { init(); animate(); } catch (e) { console.error(e); alert("Erro: " + e.message); }

        function init() {
            const container = document.createElement('div');
            document.body.appendChild(container);

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // --- RENDERER SETUP ---
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            container.appendChild(renderer.domElement);

            // --- ENVIRONMENT & LIGHTING (REALISM) ---
            const pmremGenerator = new THREE.PMREMGenerator(renderer);
            scene.environment = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;

            // Luzes adicionais para destacar metais
            const dir = new THREE.DirectionalLight(0xffffff, 2.0);
            dir.position.set(2, 5, 2);
            dir.castShadow = true;
            dir.shadow.mapSize.width = 1024; dir.shadow.mapSize.height = 1024;
            scene.add(dir);

            const spot = new THREE.SpotLight(0x00ff88, 10.0);
            spot.position.set(-2, 3, -1);
            spot.angle = 0.5; spot.penumbra = 1;
            scene.add(spot);

            // --- AR BUTTON ---
            document.body.appendChild(ARButton.createButton(renderer, {
                requiredFeatures: ['hit-test', 'dom-overlay'],
                domOverlay: { root: document.body }
            }));

            createMaterials();

            contentGroup = new THREE.Group();
            scene.add(contentGroup);

            loadObject('mobo');

            // Ret√≠culo
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.1, 0.11, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0x00ff88 })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            const controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 0.05, 0);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Eventos AR
            renderer.xr.addEventListener('sessionstart', () => {
                document.getElementById('ar-guide').style.display = 'block';
                document.getElementById('info-panel').style.opacity = '0';
                document.getElementById('selection-dock').style.transform = 'translate(-50%, 200px)'; // Hide dock
                contentGroup.visible = false;
            });
            renderer.xr.addEventListener('sessionend', () => {
                document.getElementById('ar-guide').style.display = 'none';
                document.getElementById('info-panel').style.opacity = '1';
                document.getElementById('selection-dock').style.transform = 'translateX(-50%)'; // Show dock
                contentGroup.visible = true;
                contentGroup.position.set(0, 0, 0);
                camera.position.set(0, 0.3, 0.3);
                camera.lookAt(0, 0, 0);
            });

            window.addEventListener('resize', onWindowResize);
            document.getElementById('loader').style.display = 'none';
        }

        function createMaterials() {
            // Texturas Procedurais
            const cvs = document.createElement('canvas'); cvs.width = 512; cvs.height = 512;
            const ctx = cvs.getContext('2d');

            // PCB Texture (High Res)
            ctx.fillStyle = '#080808'; ctx.fillRect(0, 0, 512, 512);
            ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 1;
            for (let i = 0; i < 100; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random() * 512, Math.random() * 512);
                ctx.lineTo(Math.random() * 512, Math.random() * 512);
                ctx.stroke();
            }
            const pcbTex = new THREE.CanvasTexture(cvs);
            pcbTex.anisotropy = 16;

            // RGB Gradient
            const cvsH = document.createElement('canvas'); cvsH.width = 512; cvsH.height = 1;
            const ctxH = cvsH.getContext('2d');
            const grdH = ctxH.createLinearGradient(0, 0, 512, 0);
            grdH.addColorStop(0, '#ff0000'); grdH.addColorStop(0.2, '#ffff00'); grdH.addColorStop(0.4, '#00ff00');
            grdH.addColorStop(0.6, '#00ffff'); grdH.addColorStop(0.8, '#0000ff'); grdH.addColorStop(1, '#ff00ff');
            ctxH.fillStyle = grdH; ctxH.fillRect(0, 0, 512, 1);
            rgbTextureH = new THREE.CanvasTexture(cvsH);
            rgbTextureH.wrapS = THREE.RepeatWrapping;

            // Materiais PBR (Physically Based Rendering)
            // O envMap vem do scene.environment automaticamente

            mats.pcb = new THREE.MeshStandardMaterial({
                map: pcbTex, color: 0x222222, roughness: 0.4, metalness: 0.3
            });

            mats.metal = new THREE.MeshStandardMaterial({
                color: 0xffffff, roughness: 0.2, metalness: 1.0
            });

            mats.alum = new THREE.MeshStandardMaterial({
                color: 0xdddddd, roughness: 0.3, metalness: 0.8
            });

            mats.copper = new THREE.MeshStandardMaterial({
                color: 0xffaa77, roughness: 0.25, metalness: 1.0
            });

            mats.blackPlastic = new THREE.MeshStandardMaterial({
                color: 0x111111, roughness: 0.6, metalness: 0.1
            });

            // RGB Emissivo (Glow)
            mats.rgbH = new THREE.MeshStandardMaterial({
                map: rgbTextureH, emissive: 0xffffff, emissiveMap: rgbTextureH,
                emissiveIntensity: 2.0, roughness: 0.2, metalness: 0.0
            });

            mats.rgbV = mats.rgbH.clone(); // Reusar por enquanto, mapeamento UV resolve
        }

        window.selectModel = function (type) {
            document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const titles = {
                'mobo': ['ASUS ROG MAXIMUS', 'E-ATX ‚Ä¢ Z790 HERO'],
                'cpu': ['RYZEN 9 7950X', 'ZEN 4 ‚Ä¢ 3D V-CACHE'],
                'gpu': ['RTX 4090 SUPRIM X', '24GB GDDR6X ‚Ä¢ LIQUID'],
                'ram': ['G.SKILL TRIDENT Z5', 'DDR5 8000MHZ ‚Ä¢ RGB']
            };
            document.getElementById('model-title').innerText = titles[type][0];
            document.getElementById('subtitle').innerText = titles[type][1];

            loadObject(type);
        }

        function loadObject(type) {
            contentGroup.clear();
            fans = []; floatParts = [];
            if (type === 'mobo') buildMobo();
            if (type === 'cpu') buildCPU_Cooler();
            if (type === 'gpu') buildGPU();
            if (type === 'ram') buildRAM();
        }

        // --- GEOMETRIA AVAN√áADA ---

        function buildMobo() {
            const g = new THREE.Group();
            // PCB Base com chanfro
            const pcb = new THREE.Mesh(new RoundedBoxGeometry(0.24, 0.004, 0.30, 4, 0.005), mats.pcb);
            pcb.receiveShadow = true; g.add(pcb);

            // VRM Heatsinks (Design Angular)
            const vrmGroup = new THREE.Group();
            const vrm1 = new THREE.Mesh(new RoundedBoxGeometry(0.04, 0.03, 0.14, 2, 0.002), mats.metal);
            vrm1.position.set(-0.08, 0.015, -0.05); vrmGroup.add(vrm1);

            // RGB Strip no VRM
            const vrmStrip = new THREE.Mesh(new THREE.BoxGeometry(0.041, 0.004, 0.12), mats.rgbH);
            vrmStrip.position.set(-0.08, 0.031, -0.05); vrmGroup.add(vrmStrip);

            const vrm2 = new THREE.Mesh(new RoundedBoxGeometry(0.14, 0.03, 0.04, 2, 0.002), mats.metal);
            vrm2.position.set(0, 0.015, -0.10); vrmGroup.add(vrm2);
            g.add(vrmGroup);

            // Capacitores High-Fidelity
            const capGeo = new THREE.CylinderGeometry(0.004, 0.004, 0.01, 32);
            const capMat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.2, metalness: 0.8 });
            for (let i = 0; i < 10; i++) {
                const cap = new THREE.Mesh(capGeo, capMat);
                cap.rotation.x = Math.PI / 2;
                cap.position.set(-0.05, 0.008, -0.08 + (i * 0.012));
                // Topo met√°lico
                const top = new THREE.Mesh(new THREE.CylinderGeometry(0.004, 0.004, 0.001, 32), mats.alum);
                top.position.y = 0.005; cap.add(top);
                g.add(cap);
            }

            // Chipset com Logo
            const chipset = new THREE.Mesh(new RoundedBoxGeometry(0.08, 0.01, 0.08, 4, 0.005), mats.blackPlastic);
            chipset.position.set(0.05, 0.01, 0.08); g.add(chipset);

            const eye = new THREE.Mesh(new THREE.PlaneGeometry(0.05, 0.05), mats.rgbH);
            eye.rotation.x = -Math.PI / 2; eye.position.set(0.05, 0.016, 0.08);
            g.add(eye);

            // I/O Shield
            const io = new THREE.Mesh(new RoundedBoxGeometry(0.05, 0.04, 0.14, 2, 0.005), mats.metal);
            io.position.set(-0.09, 0.02, -0.05); g.add(io);

            // PCIe Slots Refor√ßados
            for (let i = 0; i < 3; i++) {
                const s = new THREE.Mesh(new THREE.BoxGeometry(0.16, 0.008, 0.012), mats.metal);
                s.position.set(0.01, 0.006, 0.04 + (i * 0.06)); g.add(s);
            }
            contentGroup.add(g);
        }

        function buildCPU_Cooler() {
            const g = new THREE.Group();

            // CPU IHS
            const cpu = new THREE.Group();
            const sub = new THREE.Mesh(new THREE.BoxGeometry(0.04, 0.002, 0.04), mats.pcb);
            cpu.add(sub);
            const ihs = new THREE.Mesh(new RoundedBoxGeometry(0.034, 0.004, 0.034, 2, 0.002), mats.metal);
            ihs.position.y = 0.003; cpu.add(ihs);
            g.add(cpu);

            // Cooler Block
            const cooler = new THREE.Group();
            const block = new THREE.Mesh(new RoundedBoxGeometry(0.05, 0.01, 0.05, 4, 0.005), mats.copper);
            cooler.add(block);

            // Radiator Stack (Detailed)
            const stack = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.10, 0.05), mats.alum);
            stack.position.y = 0.06; cooler.add(stack);

            // Fan Frame
            const fanFrame = new THREE.Mesh(new RoundedBoxGeometry(0.12, 0.12, 0.025, 2, 0.005), mats.blackPlastic);
            fanFrame.position.set(0, 0.06, 0.04); cooler.add(fanFrame);

            // Fan Blades
            const fanGroup = new THREE.Group();
            fanGroup.position.set(0, 0.06, 0.052);

            for (let k = 0; k < 9; k++) {
                const b = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.012, 0.002), mats.rgbH);
                b.position.x = 0.03; b.rotation.x = 0.4;
                const p = new THREE.Group();
                p.rotation.z = (k / 9) * Math.PI * 2;
                p.add(b);
                fanGroup.add(p);
            }
            // Hub Sticker
            const hub = new THREE.Mesh(new THREE.CylinderGeometry(0.015, 0.015, 0.005, 32), mats.metal);
            hub.rotation.x = Math.PI / 2; fanGroup.add(hub);

            cooler.add(fanGroup);
            fans.push(fanGroup);

            cpu.userData = { baseY: 0.01, floatH: 0.02 }; floatParts.push(cpu);
            cooler.userData = { baseY: 0.005, floatH: 0.08 }; floatParts.push(cooler);
            g.add(cooler);
            contentGroup.add(g);
        }

        function buildGPU() {
            const g = new THREE.Group();

            // Main Body (Brushed Metal Look)
            const body = new THREE.Mesh(new RoundedBoxGeometry(0.32, 0.055, 0.13, 4, 0.01), mats.metal);
            body.position.y = 0.03; body.castShadow = true; g.add(body);

            // Backplate with Vents
            const backplate = new THREE.Mesh(new RoundedBoxGeometry(0.32, 0.004, 0.13, 4, 0.005), mats.alum);
            backplate.position.y = 0.06; g.add(backplate);
            const vent = new THREE.Mesh(new THREE.PlaneGeometry(0.08, 0.1), mats.blackPlastic);
            vent.rotation.x = -Math.PI / 2; vent.position.set(0.1, 0.063, 0); g.add(vent);

            // Copper Heatpipes
            const pipeGeo = new THREE.CylinderGeometry(0.003, 0.003, 0.1, 16);
            for (let i = 0; i < 4; i++) {
                const pipe = new THREE.Mesh(pipeGeo, mats.copper);
                pipe.rotation.z = Math.PI / 2;
                pipe.position.set(0, 0.03, -0.05 + (i * 0.03));
                g.add(pipe);
            }

            // RGB Strip Side
            const strip = new THREE.Mesh(new THREE.BoxGeometry(0.28, 0.005, 0.002), mats.rgbH);
            strip.position.set(0, 0.03, 0.066);
            g.add(strip);

            // Fans
            for (let i = -1; i <= 1; i++) {
                const xPos = i * 0.095;
                // Ring RGB
                const ring = new THREE.Mesh(new THREE.TorusGeometry(0.045, 0.002, 32, 64), mats.rgbH);
                ring.rotation.x = -Math.PI / 2; ring.position.set(xPos, 0.058, 0); g.add(ring);

                // Blades
                const fGroup = new THREE.Group();
                for (let k = 0; k < 11; k++) {
                    const b = new THREE.Mesh(new THREE.BoxGeometry(0.04, 0.008, 0.001), mats.blackPlastic);
                    b.position.x = 0.022; b.rotation.x = 0.4;
                    const p = new THREE.Group();
                    p.rotation.z = (k / 11) * Math.PI * 2;
                    p.add(b);
                    fGroup.add(p);
                }
                // Hub
                const hub = new THREE.Mesh(new THREE.CylinderGeometry(0.01, 0.01, 0.005, 32), mats.metal);
                hub.rotation.x = Math.PI / 2; fGroup.add(hub);

                fGroup.rotation.x = -Math.PI / 2; fGroup.position.set(xPos, 0.055, 0);
                g.add(fGroup);
                fans.push(fGroup);
            }
            g.rotation.x = -Math.PI / 2; g.position.y = 0.02;
            contentGroup.add(g);
        }

        function buildRAM() {
            const g = new THREE.Group();
            for (let i = -1; i <= 1; i += 2) {
                const stick = new THREE.Group();
                stick.add(new THREE.Mesh(new THREE.BoxGeometry(0.133, 0.035, 0.002), mats.pcb));

                // Heat Spreader (Aluminum)
                const heat = new THREE.Mesh(new RoundedBoxGeometry(0.135, 0.032, 0.006, 2, 0.001), mats.alum);
                heat.position.y = 0.002; stick.add(heat);

                // Black Detail
                const detail = new THREE.Mesh(new THREE.BoxGeometry(0.136, 0.01, 0.007), mats.blackPlastic);
                detail.position.y = 0.002; stick.add(detail);

                // Crystal RGB Bar
                const rgb = new THREE.Mesh(new RoundedBoxGeometry(0.135, 0.01, 0.006, 2, 0.002), mats.rgbH);
                rgb.position.y = 0.022; stick.add(rgb);

                stick.position.z = i * 0.01;
                g.add(stick);
            }
            g.position.y = 0.05;
            contentGroup.add(g);
        }

        function onSelect() {
            if (reticle.visible) {
                const p = new THREE.Vector3(); camera.getWorldPosition(p);
                contentGroup.position.setFromMatrixPosition(reticle.matrix);
                if (Math.abs(p.x - contentGroup.position.x) > 0.01) contentGroup.lookAt(p.x, contentGroup.position.y, p.z);
                contentGroup.visible = true;
                objectPlaced = true;
                document.getElementById('ar-guide').innerText = "OBJETO FIXADO";
                setTimeout(() => document.getElementById('ar-guide').style.display = 'none', 2000);
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render(timestamp, frame) {
            const t = timestamp / 1000;

            if (frame) {
                const session = renderer.xr.getSession();
                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then(ref =>
                        session.requestHitTestSource({ space: ref }).then(source => hitTestSource = source));
                    hitTestSourceRequested = true;
                }
                if (hitTestSource) {
                    const hits = frame.getHitTestResults(hitTestSource);
                    if (hits.length > 0) {
                        reticle.visible = true;
                        reticle.matrix.fromArray(hits[0].getPose(renderer.xr.getReferenceSpace()).transform.matrix);
                        if (!objectPlaced) document.getElementById('ar-guide').innerText = "TOQUE PARA POSICIONAR";
                    } else reticle.visible = false;
                }
            }

            if (contentGroup.visible || !renderer.xr.isPresenting) {
                fans.forEach(f => f.rotation.z -= 0.2);
                floatParts.forEach(p => p.position.y = p.userData.baseY + (Math.sin(t * 2) * 0.5 + 0.5) * p.userData.floatH);

                if (rgbTextureH) rgbTextureH.offset.x -= 0.015;
                if (rgbTextureV) rgbTextureV.offset.y -= 0.015;

                // OrbitControls update
                // controls.update(); // Not needed in loop if damping disabled, but enabled here
            }
            renderer.render(scene, camera);
        }
    </script>
</body>

</html>
