<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Hardware Suite v3</title>
    <!-- Fonte Futurista -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00ff9d; --bg: #050505; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Rajdhani', sans-serif; user-select: none; }

        /* Interface Superior */
        #ui-container {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px; box-sizing: border-box;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            display: flex; justify-content: center; gap: 10px;
            z-index: 10; pointer-events: none; /* Permite clicar atrav√©s */
        }

        .obj-btn {
            pointer-events: auto;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            color: #888;
            width: 75px; height: 65px;
            border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .obj-btn.active {
            border-color: var(--neon); color: white;
            background: rgba(0, 255, 157, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.2);
            transform: translateY(2px);
        }

        .obj-btn span { font-size: 22px; margin-bottom: 2px; }
        .obj-btn label { font-size: 10px; font-weight: 700; letter-spacing: 1px; }

        /* Avisos e Loader */
        #status-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); border: 1px solid var(--neon);
            color: white; padding: 15px 25px; border-radius: 30px;
            display: none; text-align: center; font-weight: bold; pointer-events: none;
        }

        #loader {
            position: absolute; inset: 0; background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .spinner {
            width: 40px; height: 40px; border: 4px solid #222; border-top: 4px solid var(--neon);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { to {transform: rotate(360deg);} }

        #error-log {
            color: #ff4444; font-family: monospace; font-size: 12px; 
            margin-top: 20px; max-width: 80%; text-align: center; display: none;
        }

        /* Bot√£o AR Nativo */
        button#ARButton {
            bottom: 30px !important; width: 180px !important;
            background: var(--neon) !important; color: black !important;
            border-radius: 4px !important; font-weight: 800 !important;
            text-transform: uppercase !important;
        }
    </style>
</head>
<body>

    <!-- Menu de Sele√ß√£o -->
    <div id="ui-container">
        <div class="obj-btn active" onclick="window.changeModel('mobo')">
            <span>üéõÔ∏è</span><label>MOBO</label>
        </div>
        <div class="obj-btn" onclick="window.changeModel('gpu')">
            <span>üìº</span><label>GPU</label>
        </div>
        <div class="obj-btn" onclick="window.changeModel('ram')">
            <span>üíæ</span><label>RAM</label>
        </div>
        <div class="obj-btn" onclick="window.changeModel('cooler')">
            <span>‚ùÑÔ∏è</span><label>COOLER</label>
        </div>
    </div>

    <div id="status-msg">Detectando ch√£o...</div>
    
    <div id="loader">
        <div class="spinner"></div>
        <div id="loading-text">INICIALIZANDO ENGINE...</div>
        <div id="error-log"></div>
    </div>

    <!-- Import Map (Vers√£o Est√°vel r160) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoundedBoxGeometry } from 'three/addons/geometries/RoundedBoxGeometry.js';

        // Vari√°veis Globais
        let camera, scene, renderer;
        let contentGroup, reticle;
        let hitTestSource = null, hitTestSourceRequested = false;
        let objectPlaced = false;
        
        // Arrays de anima√ß√£o
        let rotatingParts = []; 
        let pulsatingParts = [];

        // Cache de Materiais
        const mats = {};

        // Inicializa√ß√£o Segura
        try {
            init();
            animate();
        } catch (e) {
            showError("Erro Cr√≠tico: " + e.message);
        }

        function showError(msg) {
            const el = document.getElementById('error-log');
            el.style.display = 'block';
            el.innerText = msg;
            document.getElementById('loading-text').style.display = 'none';
            document.querySelector('.spinner').style.display = 'none';
        }

        function init() {
            const container = document.createElement('div');
            document.body.appendChild(container);

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // Ilumina√ß√£o
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x222222, 1);
            scene.add(hemiLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 3);
            dirLight.position.set(1, 3, 1);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.shadowMap.enabled = true;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            container.appendChild(renderer.domElement);

            // Bot√£o AR
            document.body.appendChild(ARButton.createButton(renderer, { 
                requiredFeatures: ['hit-test', 'dom-overlay'],
                domOverlay: { root: document.body }
            }));

            // Materiais
            createMaterials();

            // Grupo de Conte√∫do
            contentGroup = new THREE.Group();
            scene.add(contentGroup);

            // Mira (Ret√≠culo)
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.1, 0.11, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0x00ff9d })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // Modelo Inicial
            buildMobo(); // Carrega mobo direto na init

            // Intera√ß√£o
            const controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            // Controles Orbit (PC)
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 0.05, 0);
            controls.update();

            // Eventos AR
            renderer.xr.addEventListener('sessionstart', () => {
                document.getElementById('status-msg').style.display = 'block';
                contentGroup.visible = false;
                objectPlaced = false;
            });
            
            renderer.xr.addEventListener('sessionend', () => {
                document.getElementById('status-msg').style.display = 'none';
                contentGroup.visible = true;
                contentGroup.position.set(0,0,0);
                contentGroup.rotation.set(0,0,0);
                camera.position.set(0, 0.3, 0.3);
                camera.lookAt(0,0,0);
            });

            window.addEventListener('resize', onWindowResize);
            
            // Remover Loader se tudo deu certo
            document.getElementById('loader').style.display = 'none';
        }

        function createMaterials() {
            // Textura Procedural (R√°pida)
            const canvas = document.createElement('canvas'); canvas.width=512; canvas.height=512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle='#111'; ctx.fillRect(0,0,512,512);
            ctx.strokeStyle='#222'; ctx.lineWidth=3;
            for(let i=0; i<50; i++){
                ctx.beginPath(); ctx.moveTo(Math.random()*512,Math.random()*512);
                ctx.lineTo(Math.random()*512,Math.random()*512); ctx.stroke();
            }
            const tex = new THREE.CanvasTexture(canvas);

            mats.pcb = new THREE.MeshStandardMaterial({ map: tex, color: 0x222222, roughness: 0.4 });
            mats.metal = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.2, metalness: 0.9 });
            mats.alum = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.3, metalness: 0.7 });
            mats.copper = new THREE.MeshStandardMaterial({ color: 0xb87333, roughness: 0.4, metalness: 0.6 });
            mats.rgb = new THREE.MeshStandardMaterial({ color: 0x000000, emissive: 0x00ff9d, emissiveIntensity: 2 });
            mats.gold = new THREE.MeshStandardMaterial({ color: 0xffd700, roughness: 0.1, metalness: 1.0 });
        }

        // --- FUN√á√ÉO DE TROCA ---
        window.changeModel = function(type) {
            // Atualizar UI
            document.querySelectorAll('.obj-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Limpar cena
            contentGroup.clear();
            rotatingParts = [];
            pulsatingParts = [];

            // Carregar novo
            try {
                if(type === 'mobo') buildMobo();
                if(type === 'gpu') buildGPU();
                if(type === 'ram') buildRAM();
                if(type === 'cooler') buildCooler();
            } catch(e) {
                console.error(e);
            }
        }

        // --- BUILDERS (CORRIGIDOS) ---

        function buildMobo() {
            const g = new THREE.Group();
            // PCB
            const pcb = new THREE.Mesh(new RoundedBoxGeometry(0.24, 0.004, 0.30, 4, 0.01), mats.pcb);
            pcb.receiveShadow = true; g.add(pcb);

            // Heatsinks
            const vrm1 = new THREE.Mesh(new THREE.BoxGeometry(0.03, 0.02, 0.10), mats.metal);
            vrm1.position.set(-0.08, 0.012, -0.05); g.add(vrm1);
            
            const vrm2 = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.02, 0.03), mats.metal);
            vrm2.position.set(0, 0.012, -0.10); g.add(vrm2);

            // Slots RAM
            for(let i=0; i<4; i++) {
                const s = new THREE.Mesh(new THREE.BoxGeometry(0.005, 0.008, 0.13), mats.metal);
                s.position.set(0.04 + (i*0.01), 0.006, -0.05); g.add(s);
            }

            // PCIE
            for(let i=0; i<3; i++) {
                const p = new THREE.Mesh(new THREE.BoxGeometry(0.16, 0.008, 0.01), mats.metal);
                p.position.set(0, 0.006, 0.04 + (i*0.06)); g.add(p);
            }
            
            // Logo RGB
            const logo = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.01, 0.05), mats.rgb);
            logo.position.set(0.05, 0.005, 0.10); g.add(logo);
            pulsatingParts.push(logo.material);

            contentGroup.add(g);
        }

        function buildGPU() {
            const g = new THREE.Group();
            // Corpo
            const body = new THREE.Mesh(new RoundedBoxGeometry(0.30, 0.05, 0.12, 4, 0.01), mats.metal);
            body.position.y = 0.05; body.castShadow = true; g.add(body);

            // 3 Fans (Rota√ß√£o Corrigida)
            for(let i=-1; i<=1; i++) {
                // Criar o grupo da ventoinha na origem (0,0,0)
                const fanGroup = new THREE.Group();
                
                // H√©lice
                const bladeGeo = new THREE.BoxGeometry(0.035, 0.002, 0.008);
                for(let j=0; j<9; j++) {
                    const blade = new THREE.Mesh(bladeGeo, mats.rgb); // RGB Fans
                    blade.position.x = 0.02; // Deslocar do centro
                    
                    const pivot = new THREE.Group();
                    pivot.rotation.y = (j/9) * Math.PI * 2;
                    pivot.add(blade);
                    fanGroup.add(pivot);
                }
                
                // Posicionar o grupo inteiro no lugar certo na GPU
                fanGroup.position.set(i*0.09, 0.076, 0); 
                // N√£o giramos o fanGroup aqui, apenas o movemos.
                // Vamos adicionar o fanGroup √† lista de rota√ß√£o, mas rota√ß√£o Y LOCAL.
                
                g.add(fanGroup);
                rotatingParts.push(fanGroup);
            }

            g.rotation.x = -Math.PI/2; // Deitar GPU
            g.position.y = 0.01;
            contentGroup.add(g);
        }

        function buildCooler() {
            const g = new THREE.Group();
            
            // Aletas
            const fin = new THREE.BoxGeometry(0.05, 0.001, 0.10);
            for(let i=0; i<30; i++) {
                const f = new THREE.Mesh(fin, mats.alum);
                f.position.y = 0.03 + (i*0.003);
                g.add(f);
            }
            
            // Heatpipes
            const pipe = new THREE.Mesh(new THREE.CylinderGeometry(0.003, 0.003, 0.12), mats.copper);
            pipe.position.y = 0.07;
            g.add(pipe);

            // Fan Lateral (Rota√ß√£o Corrigida)
            const fanGroup = new THREE.Group();
            const bladeGeo = new THREE.BoxGeometry(0.04, 0.002, 0.008);
            for(let j=0; j<7; j++) {
                const blade = new THREE.Mesh(bladeGeo, mats.rgb);
                blade.position.x = 0.025;
                const p = new THREE.Group();
                p.rotation.z = (j/7)*Math.PI*2;
                p.add(blade);
                fanGroup.add(p);
            }
            
            fanGroup.position.set(0, 0.08, 0.055); // Frente do cooler
            g.add(fanGroup);
            
            // Importante: A h√©lice foi constru√≠da no plano XY (rotation Z).
            // Precisamos animar rotation.z
            fanGroup.userData = { axis: 'z' }; 
            rotatingParts.push(fanGroup);

            g.position.y = 0.01;
            contentGroup.add(g);
        }

        function buildRAM() {
            const g = new THREE.Group();
            const stick = new THREE.Group();
            
            const pcb = new THREE.Mesh(new THREE.BoxGeometry(0.13, 0.035, 0.002), mats.pcb);
            stick.add(pcb);
            
            const heat = new THREE.Mesh(new THREE.BoxGeometry(0.13, 0.03, 0.005), mats.alum);
            heat.position.y = 0.002; stick.add(heat);
            
            const rgb = new THREE.Mesh(new THREE.BoxGeometry(0.13, 0.004, 0.006), mats.rgb);
            rgb.position.y = 0.018; stick.add(rgb);
            pulsatingParts.push(rgb.material);

            stick.position.y = 0.04;
            g.add(stick);
            contentGroup.add(g);
        }

        // --- LOGICA AR ---

        function onSelect() {
            if (reticle.visible) {
                contentGroup.position.setFromMatrixPosition(reticle.matrix);
                const p = new THREE.Vector3(); camera.getWorldPosition(p);
                contentGroup.lookAt(p.x, contentGroup.position.y, p.z);
                contentGroup.visible = true;
                objectPlaced = true;
                document.getElementById('status-msg').innerText = "Objeto Fixado!";
                setTimeout(() => document.getElementById('status-msg').style.display='none', 2000);
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render(timestamp, frame) {
            // AR Hit Test
            if (frame) {
                const session = renderer.xr.getSession();
                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then(ref => 
                        session.requestHitTestSource({ space: ref }).then(source => hitTestSource = source));
                    hitTestSourceRequested = true;
                }
                if (hitTestSource) {
                    const hits = frame.getHitTestResults(hitTestSource);
                    if (hits.length > 0) {
                        reticle.visible = true;
                        reticle.matrix.fromArray(hits[0].getPose(renderer.xr.getReferenceSpace()).transform.matrix);
                        if(!objectPlaced) document.getElementById('status-msg').innerText = "Toque para posicionar";
                    } else reticle.visible = false;
                }
            }

            // Anima√ß√µes
            if(contentGroup.visible || !renderer.xr.isPresenting) {
                // Rota√ß√£o
                rotatingParts.forEach(part => {
                    if(part.userData.axis === 'z') part.rotation.z -= 0.2;
                    else part.rotation.y -= 0.2;
                });

                // Pulso RGB
                const hue = (timestamp * 0.0005) % 1;
                pulsatingParts.forEach(mat => mat.emissive.setHSL(hue, 1, 0.5));

                // Rota√ß√£o Showcase (PC)
                if(!renderer.xr.isPresenting) contentGroup.rotation.y += 0.005;
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>


