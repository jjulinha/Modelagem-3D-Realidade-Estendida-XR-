<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hardware AR Suite - High Fidelity</title>
    <style>
        /* --- ESTILO GERAL E UI --- */
        body { 
            margin: 0; overflow: hidden; background-color: #0a0a0a; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
        }
        
        /* Menu de Sele√ß√£o (Inferior) */
        #selection-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 20;
            transition: opacity 0.3s;
        }

        .item-btn {
            background: transparent; border: none; color: white;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; opacity: 0.6; transition: all 0.2s;
        }

        .item-btn.active { opacity: 1; transform: scale(1.1); color: #00ff88; }
        
        .item-icon { font-size: 24px; margin-bottom: 5px; background: #333; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .item-name { font-size: 10px; font-weight: bold; letter-spacing: 1px; }

        /* Painel de Instru√ß√µes (Centro) */
        #instruction-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 15;
            width: 80%;
        }

        .instruction-text {
            color: white; font-size: 16px; font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.6);
            padding: 10px 20px; border-radius: 8px;
            display: inline-block;
            border-left: 3px solid #00ff88;
        }

        /* √çcone animado de "Mover Celular" */
        #scan-icon {
            width: 60px; height: 100px; border: 3px solid rgba(255,255,255,0.5);
            border-radius: 10px; margin: 0 auto 20px auto;
            animation: scan-move 2s infinite ease-in-out;
            display: none; /* S√≥ aparece no AR */
        }
        @keyframes scan-move {
            0% { transform: translateX(-30px) rotateY(-15deg); }
            50% { transform: translateX(30px) rotateY(15deg); }
            100% { transform: translateX(-30px) rotateY(-15deg); }
        }

        /* Informa√ß√µes T√©cnicas (Topo) */
        #tech-specs {
            position: absolute; top: 20px; left: 20px;
            color: #00ff88; font-family: 'Courier New', monospace;
            font-size: 12px; text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
            pointer-events: none; z-index: 15;
        }

        /* Aviso de Erro */
        #ar-warning {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: white;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            text-align: center; z-index: 1000; display: none;
        }

        .loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: #00ff88; font-family: monospace; }
    </style>
</head>
<body>

    <!-- UI de Sele√ß√£o -->
    <div id="selection-bar">
        <button class="item-btn active" onclick="selectModel('cpu')">
            <div class="item-icon">‚ö°</div>
            <span class="item-name">CPU</span>
        </button>
        <button class="item-btn" onclick="selectModel('ram')">
            <div class="item-icon">üíæ</div>
            <span class="item-name">RAM</span>
        </button>
        <button class="item-btn" onclick="selectModel('gpu')">
            <div class="item-icon">üéÆ</div>
            <span class="item-name">GPU</span>
        </button>
    </div>

    <!-- Painel de Instru√ß√µes -->
    <div id="instruction-panel" style="display: none;">
        <div id="scan-icon"></div>
        <div class="instruction-text" id="instruction-text">Iniciando AR...</div>
    </div>

    <!-- Specs T√©cnicas -->
    <div id="tech-specs">
        SYSTEM: ONLINE<br>
        <span id="model-name">RYZEN 9 7950X</span><br>
        ESCALA: 1:1 (REAL)
    </div>

    <div id="ar-warning">
        <h2>‚ö†Ô∏è HTTPS Necess√°rio</h2>
        <p>Para usar AR, acesse via HTTPS ou Localhost.</p>
    </div>
    <div class="loader" id="loader">CARREGANDO ASSETS...</div>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Seguran√ßa HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            document.getElementById('ar-warning').style.display = 'flex';
            document.getElementById('loader').style.display = 'none';
        }

        // --- VARI√ÅVEIS ---
        let camera, scene, renderer, controller;
        let reticle, contentGroup;
        let hitTestSource = null, hitTestSourceRequested = false;
        let objectPlaced = false;
        let currentType = 'cpu'; // cpu, ram, gpu
        let animatedObjects = { fans: [], leds: [] };

        // Materiais Compartilhados (Cache)
        const materials = {};

        init();
        animate();

        function init() {
            const container = document.createElement('div');
            document.body.appendChild(container);

            scene = new THREE.Scene();

            // C√¢mera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // Luzes
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
            hemiLight.position.set(0, 1, 0);
            scene.add(hemiLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 3);
            dirLight.position.set(1, 2, 1);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 1024;
            dirLight.shadow.mapSize.height = 1024;
            scene.add(dirLight);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            container.appendChild(renderer.domElement);

            // Setup AR Button com suporte a DOM Overlay (para UI funcionar em AR no Android)
            const arButton = ARButton.createButton(renderer, { 
                requiredFeatures: ['hit-test', 'dom-overlay'],
                domOverlay: { root: document.body } 
            });
            document.body.appendChild(arButton);

            // Inicializar Materiais
            initMaterials();

            // Grupo Principal
            contentGroup = new THREE.Group();
            contentGroup.visible = false; // S√≥ aparece ao tocar
            scene.add(contentGroup);

            // Carregar modelo inicial
            loadModel('cpu');

            // Ret√≠culo (Mira)
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.1, 0.11, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0xffffff })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // Controller (Toque)
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            // Controles para PC (Debug)
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 0, 0);
            controls.update();

            // Eventos UI AR
            renderer.xr.addEventListener('sessionstart', onARStart);
            renderer.xr.addEventListener('sessionend', onAREnd);

            window.addEventListener('resize', onWindowResize);
            document.getElementById('loader').style.display = 'none';
        }

        // --- MATERIAIS & TEXTURAS ---
        function initMaterials() {
            const pcbTex = createPCBTexture();
            
            materials.pcb = new THREE.MeshStandardMaterial({ map: pcbTex, roughness: 0.5, metalness: 0.1 });
            materials.metalDark = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.3, metalness: 0.8 });
            materials.gold = new THREE.MeshStandardMaterial({ color: 0xffd700, roughness: 0.2, metalness: 1.0 });
            materials.aluminum = new THREE.MeshStandardMaterial({ color: 0xdddddd, roughness: 0.3, metalness: 0.7 });
            materials.plastic = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.6 });
            materials.rgb = new THREE.MeshStandardMaterial({ color: 0x000000, emissive: 0xff0055, emissiveIntensity: 2 });
            materials.silicon = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.1, metalness: 0.5 });
        }

        function createPCBTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#0a1a10'; ctx.fillRect(0,0,512,512);
            ctx.strokeStyle = '#1f3d2b'; ctx.lineWidth = 3;
            for(let i=0; i<100; i++) {
                ctx.beginPath(); ctx.moveTo(Math.random()*512, Math.random()*512);
                ctx.lineTo(Math.random()*512, Math.random()*512); ctx.stroke();
            }
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        // --- GERADORES DE MODELOS (PROCEDURAL) ---

        // 1. CPU (Ryzen Style)
        function createCPU() {
            const group = new THREE.Group();
            // PCB: 40mm
            const pcb = new THREE.Mesh(new THREE.BoxGeometry(0.04, 0.002, 0.04), materials.pcb);
            pcb.castShadow = true;
            group.add(pcb);
            // IHS (Heatspreader)
            const ihs = new THREE.Mesh(new THREE.BoxGeometry(0.034, 0.004, 0.034), materials.aluminum);
            ihs.position.y = 0.003; ihs.castShadow = true;
            group.add(ihs);
            return group;
        }

        // 2. RAM (DDR5 Stick)
        function createRAM() {
            const group = new THREE.Group();
            // PCB Longo: 133mm x 30mm
            const pcb = new THREE.Mesh(new THREE.BoxGeometry(0.133, 0.03, 0.002), materials.pcb);
            pcb.position.y = 0.015; // Metade da altura para pivot no ch√£o
            group.add(pcb);

            // Chips de Mem√≥ria
            const chipGeo = new THREE.BoxGeometry(0.01, 0.008, 0.001);
            for(let i=0; i<8; i++) {
                const chip = new THREE.Mesh(chipGeo, materials.silicon);
                chip.position.set((i*0.015) - 0.05, 0.015, 0.002);
                group.add(chip);
            }

            // Dissipador de Calor (Heatspreader)
            const heatspreader = new THREE.Mesh(new THREE.BoxGeometry(0.135, 0.035, 0.006), materials.metalDark);
            heatspreader.position.y = 0.018;
            heatspreader.castShadow = true;
            group.add(heatspreader);

            // Barra RGB
            const rgbBar = new THREE.Mesh(new THREE.BoxGeometry(0.135, 0.004, 0.006), materials.rgb);
            rgbBar.position.y = 0.037;
            group.add(rgbBar);
            
            animatedObjects.leds.push(rgbBar.material);
            return group;
        }

        // 3. GPU (RTX Style)
        function createGPU() {
            const group = new THREE.Group();
            // Tamanho real aprox: 30cm comprimento
            
            // Bloco Principal (Heatsink + Shroud)
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.30, 0.06, 0.12), materials.metalDark);
            body.position.set(0, 0.03, 0);
            body.castShadow = true;
            group.add(body);

            // Backplate
            const backplate = new THREE.Mesh(new THREE.BoxGeometry(0.30, 0.002, 0.12), materials.aluminum);
            backplate.position.set(0, 0.061, 0);
            group.add(backplate);

            // Ventoinhas (3 Fans)
            const fanGeo = new THREE.CylinderGeometry(0.035, 0.035, 0.005, 16);
            for(let i=-1; i<=1; i++) {
                const fan = new THREE.Mesh(fanGeo, materials.plastic);
                fan.rotation.x = Math.PI / 2;
                fan.position.set(i * 0.09, -0.001, 0); // Embaixo
                
                // P√°s da ventoinha (visual simples)
                const blade = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.005, 0.01), materials.plastic);
                fan.add(blade);
                const blade2 = new THREE.Mesh(new THREE.BoxGeometry(0.01, 0.005, 0.06), materials.plastic);
                fan.add(blade2);

                group.add(fan);
                animatedObjects.fans.push(fan);
            }
            
            // RGB Logo Lateral
            const logo = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.01, 0.002), materials.rgb);
            logo.position.set(0, 0.03, 0.061); // Lado
            group.add(logo);
            animatedObjects.leds.push(logo.material);

            return group;
        }

        // --- L√ìGICA DE SELE√á√ÉO ---
        window.selectModel = function(type) {
            currentType = type;
            
            // Atualizar UI
            document.querySelectorAll('.item-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Atualizar Texto
            const names = {
                'cpu': 'RYZEN 9 7950X',
                'ram': 'DDR5 TRIDENT Z (16GB)',
                'gpu': 'RTX 4090 FOUNDERS'
            };
            document.getElementById('model-name').innerText = names[type];

            // Trocar Modelo 3D
            loadModel(type);
        }

        function loadModel(type) {
            // Limpar anterior
            contentGroup.clear();
            animatedObjects.fans = [];
            animatedObjects.leds = [];

            let mesh;
            if(type === 'cpu') mesh = createCPU();
            if(type === 'ram') mesh = createRAM();
            if(type === 'gpu') mesh = createGPU();

            contentGroup.add(mesh);
        }

        // --- L√ìGICA AR / HIT TEST ---
        function onSelect() {
            if (reticle.visible) {
                contentGroup.position.setFromMatrixPosition(reticle.matrix);
                contentGroup.visible = true;
                contentGroup.lookAt(camera.position.x, contentGroup.position.y, camera.position.z); // Virar pro usuario
                objectPlaced = true;
                updateInstruction("Objeto Posicionado!");
                setTimeout(() => updateInstruction(""), 2000);
            }
        }

        function onARStart() {
            document.getElementById('instruction-panel').style.display = 'block';
            document.getElementById('scan-icon').style.display = 'block';
            updateInstruction("Aponte para o ch√£o e mova lentamente");
            contentGroup.visible = false;
            objectPlaced = false;
        }

        function onAREnd() {
            document.getElementById('instruction-panel').style.display = 'none';
            contentGroup.visible = true; // Volta a mostrar no modo PC
            contentGroup.position.set(0,0,0);
        }

        function updateInstruction(text) {
            const el = document.getElementById('instruction-text');
            if(!text) {
                el.style.display = 'none';
            } else {
                el.style.display = 'inline-block';
                el.innerText = text;
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- LOOP ---
        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render(timestamp, frame) {
            const delta = timestamp;

            if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then((refSpace) => {
                        session.requestHitTestSource({ space: refSpace }).then((source) => {
                            hitTestSource = source;
                        });
                    });
                    hitTestSourceRequested = true;
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                        
                        if(!objectPlaced) {
                            updateInstruction("Superf√≠cie detectada! Toque para colocar");
                            document.getElementById('scan-icon').style.display = 'none';
                        }
                    } else {
                        reticle.visible = false;
                        if(!objectPlaced) updateInstruction("Mova o celular para escanear...");
                    }
                }
            }

            // Anima√ß√µes
            if(contentGroup.visible || !renderer.xr.isPresenting) {
                // Girar fans
                animatedObjects.fans.forEach(fan => {
                    fan.rotation.y -= 0.15;
                });

                // Pulsar LEDs
                animatedObjects.leds.forEach(mat => {
                    const hue = (delta * 0.0005) % 1;
                    mat.emissive.setHSL(hue, 1, 0.5);
                });

                // Levita√ß√£o suave se for apenas showcase (PC) ou se usu√°rio quiser
                if(!renderer.xr.isPresenting) {
                    contentGroup.rotation.y += 0.005;
                }
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>

