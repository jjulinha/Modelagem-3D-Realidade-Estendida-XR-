<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hardware AR - Ultimate Edition</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@300;400;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #00ff88;
            --accent: #00ccff;
            --glass: rgba(10, 15, 20, 0.6);
            --glass-border: rgba(0, 255, 136, 0.2);
            --text: #ffffff;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Inter', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UI TECH (Centralizada & Moderna) --- */

        #header-container {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            width: 90%;
            max-width: 600px;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        h1 {
            margin: 0;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 32px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.5);
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
        }

        /* Doca Tech */
        #selection-dock {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 16px;
            padding: 16px 24px;
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.1);
            z-index: 20;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .model-btn {
            width: 64px;
            height: 64px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .model-btn:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .model-btn.active {
            border-color: var(--primary);
            color: white;
            transform: translateY(-6px);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3), inset 0 0 10px rgba(0, 255, 136, 0.1);
            background: rgba(0, 255, 136, 0.05);
        }

        .btn-icon {
            font-size: 24px;
            margin-bottom: 4px;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.8));
        }

        .btn-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            font-family: 'Rajdhani';
        }

        /* Bot√£o AR Centralizado */
        button#ARButton {
            position: absolute !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            bottom: 40px !important;
            background: var(--primary) !important;
            color: black !important;
            border-radius: 8px !important;
            width: 200px !important;
            height: 48px !important;
            font-family: 'Rajdhani' !important;
            font-weight: 700 !important;
            font-size: 16px !important;
            text-transform: uppercase !important;
            letter-spacing: 2px !important;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4) !important;
            border: none !important;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }

        #ar-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 16px 32px;
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Rajdhani';
            font-weight: 700;
            display: none;
            pointer-events: none;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
        }

        #loader {
            position: absolute;
            inset: 0;
            background: #050505;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 2px solid rgba(0, 255, 136, 0.1);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.8s infinite linear;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="header-container">
        <h1>Hardware AR</h1>
        <div id="subtitle">Selecione um componente para visualizar em 3D</div>
    </div>

    <div id="selection-dock">
        <div class="model-btn active" onclick="window.selectModel('mobo')">
            <div class="btn-icon">üéõÔ∏è</div>
            <div class="btn-label">MOBO</div>
        </div>
        <div class="model-btn" onclick="window.selectModel('cpu')">
            <div class="btn-icon">‚ùÑÔ∏è</div>
            <div class="btn-label">COOLER</div>
        </div>
        <div class="model-btn" onclick="window.selectModel('gpu')">
            <div class="btn-icon">üìº</div>
            <div class="btn-label">GPU</div>
        </div>
        <div class="model-btn" onclick="window.selectModel('ram')">
            <div class="btn-icon">üíæ</div>
            <div class="btn-label">RAM</div>
        </div>
    </div>

    <div id="ar-guide">Mova o celular...</div>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoundedBoxGeometry } from 'three/addons/geometries/RoundedBoxGeometry.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

        let camera, scene, renderer;
        let contentGroup, reticle;
        let hitTestSource = null, hitTestSourceRequested = false;
        let objectPlaced = false;

        let fans = [];
        let floatParts = [];
        let rgbTextureH, rgbTextureV;
        const mats = {};

        // Helper para "respirar" a UI (Yield)
        const yieldToMain = () => new Promise(resolve => setTimeout(resolve, 0));

        try { init(); animate(); } catch (e) { console.error(e); }

        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        container.appendChild(renderer.domElement);
        await yieldToMain();

        // Step 3: Environment (Heavy!)
        const pmremGenerator = new THREE.PMREMGenerator(renderer);
        scene.environment = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;
        await yieldToMain();

        // Step 4: Lights & AR Button
        const dir = new THREE.DirectionalLight(0xffffff, 2.5);
        dir.position.set(2, 5, 2); dir.castShadow = true; scene.add(dir);
        const spot = new THREE.SpotLight(0x00ff88, 8.0);
        spot.position.set(-2, 3, -1); spot.angle = 0.6; scene.add(spot);

        document.body.appendChild(ARButton.createButton(renderer, {
            requiredFeatures: ['hit-test', 'dom-overlay'],
            domOverlay: { root: document.body }
        }));
        await yieldToMain();

        // Step 5: Materials (Heavy Canvas Ops + Assets)
        await createMaterials();
        await yieldToMain();

        // Step 6: Content & Logic
        contentGroup = new THREE.Group();
        scene.add(contentGroup);

        loadObject('mobo'); // Initial Load

        reticle = new THREE.Mesh(
            new THREE.RingGeometry(0.1, 0.11, 32).rotateX(-Math.PI / 2),
            new THREE.MeshBasicMaterial({ color: 0x00ff88 })
        );
        reticle.matrixAutoUpdate = false; reticle.visible = false; scene.add(reticle);

        const controller = renderer.xr.getController(0);
        controller.addEventListener('select', onSelect);
        scene.add(controller);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 0.05, 0); controls.enableDamping = true;

        renderer.xr.addEventListener('sessionstart', () => {
            document.getElementById('ar-guide').style.display = 'block';
            document.getElementById('header-container').style.opacity = '0';
            document.getElementById('selection-dock').style.display = 'none';
            contentGroup.visible = false;
        });
        renderer.xr.addEventListener('sessionend', () => {
            document.getElementById('ar-guide').style.display = 'none';
            document.getElementById('header-container').style.opacity = '1';
            document.getElementById('selection-dock').style.display = 'flex';
            contentGroup.visible = true;
            contentGroup.position.set(0, 0, 0);
            camera.position.set(0, 0.3, 0.3); camera.lookAt(0, 0, 0);

            // FIX: Reset AR Hit Test state
            hitTestSource = null;
            hitTestSourceRequested = false;
            objectPlaced = false;
            reticle.visible = false;
        });

        window.addEventListener('resize', onWindowResize);

        // Done! Hide Loader
        document.getElementById('loader').style.display = 'none';
        }

        async function createMaterials() {
            const loader = new THREE.TextureLoader();

            // Helper para carregar textura como Promise
            const loadTex = (path) => new Promise(resolve => {
                loader.load(path, (tex) => {
                    tex.colorSpace = THREE.SRGBColorSpace;
                    resolve(tex);
                }, undefined, () => {
                    console.warn(`Falha ao carregar ${path}, usando fallback.`);
                    resolve(null);
                });
            });

            // Carregar Assets (Async)
            const [pcbTex, stickerTex, metalTex, whitePlasTex, blackPlasTex, copperTex] = await Promise.all([
                loadTex('assets/pcb.png'),
                loadTex('assets/sticker.png'),
                loadTex('assets/metal.png'),
                loadTex('assets/plastic_white.png'),
                loadTex('assets/plastic_black.png'),
                loadTex('assets/copper.png')
            ]);

            // Texturas Procedurais (Fallback ou Auxiliares)
            const cvsF = document.createElement('canvas'); cvsF.width = 64; cvsF.height = 64;
            const ctxF = cvsF.getContext('2d');
            ctxF.fillStyle = '#ccc'; ctxF.fillRect(0, 0, 64, 64);
            ctxF.fillStyle = '#888';
            for (let i = 0; i < 64; i += 4) { ctxF.fillRect(i, 0, 2, 64); }
            const finsTex = new THREE.CanvasTexture(cvsF);

            // RGB Rainbow (Gradient)
            const cvsH = document.createElement('canvas'); cvsH.width = 256; cvsH.height = 1;
            const ctxH = cvsH.getContext('2d');
            const grdH = ctxH.createLinearGradient(0, 0, 256, 0);
            grdH.addColorStop(0, '#ff0000'); grdH.addColorStop(0.2, '#ffff00'); grdH.addColorStop(0.4, '#00ff00');
            grdH.addColorStop(0.6, '#00ffff'); grdH.addColorStop(0.8, '#0000ff'); grdH.addColorStop(1, '#ff00ff');
            ctxH.fillStyle = grdH; ctxH.fillRect(0, 0, 256, 1);
            rgbTextureH = new THREE.CanvasTexture(cvsH);
            rgbTextureH.wrapS = THREE.RepeatWrapping;

            // MATERIAIS COM ASSETS

            // PCB
            mats.pcb = new THREE.MeshStandardMaterial({
                map: pcbTex,
                color: pcbTex ? 0xffffff : 0x222222,
                roughness: 0.4, metalness: 0.3
            });

            // Metal Escovado (Heatsinks)
            mats.metal = new THREE.MeshStandardMaterial({
                map: metalTex,
                color: 0xffffff, roughness: 0.3, metalness: 0.9
            });

            // Sticker (Usado nos Hubs)
            mats.sticker = new THREE.MeshStandardMaterial({
                map: stickerTex,
                color: 0xffffff, roughness: 0.2, metalness: 0.8
            });

            // Black Metal (Darkened Metal Texture)
            mats.blackMetal = new THREE.MeshStandardMaterial({
                map: metalTex,
                color: 0x222222, roughness: 0.3, metalness: 0.9
            });

            // White Plastic
            mats.whitePlastic = new THREE.MeshStandardMaterial({
                map: whitePlasTex,
                color: 0xffffff, roughness: 0.3, metalness: 0.1
            });

            // Black Plastic
            mats.blackPlastic = new THREE.MeshStandardMaterial({
                map: blackPlasTex,
                color: 0x111111, roughness: 0.6, metalness: 0.1
            });

            // Copper
            mats.copper = new THREE.MeshStandardMaterial({
                map: copperTex,
                color: 0xffaa77, roughness: 0.25, metalness: 1.0
            });

            mats.alum = new THREE.MeshStandardMaterial({ color: 0xdddddd, roughness: 0.3, metalness: 0.8 });
            mats.fins = new THREE.MeshStandardMaterial({ map: finsTex, color: 0xdddddd, roughness: 0.5, metalness: 0.6 });
            mats.rgbH = new THREE.MeshStandardMaterial({ map: rgbTextureH, emissive: 0xffffff, emissiveMap: rgbTextureH, emissiveIntensity: 2.5, roughness: 0.2, metalness: 0.0 });

            // Fan Blade Material (Frosted Acrylic)
            mats.fanBlade = new THREE.MeshPhysicalMaterial({
                color: 0xffffff, roughness: 0.4, metalness: 0.1,
                transmission: 0.6, thickness: 0.002, transparent: true, opacity: 0.9
            });
            mats.fanBladeBlack = new THREE.MeshPhysicalMaterial({
                color: 0x222222, roughness: 0.4, metalness: 0.1,
                transmission: 0.4, thickness: 0.002, transparent: true, opacity: 0.95
            });
        }

        window.selectModel = function (type) {
            document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const titles = {
                'mobo': 'ASUS ROG MAXIMUS',
                'cpu': 'BLACK TOWER COOLER',
                'gpu': 'ROG STRIX WHITE',
                'ram': 'TRIDENT Z5 RGB'
            };
            document.querySelector('#header-container h1').innerText = titles[type];
            loadObject(type);
        }

        function loadObject(type) {
            contentGroup.clear();
            fans = []; floatParts = [];
            if (type === 'mobo') buildMobo();
            if (type === 'cpu') buildCPU_Cooler();
            if (type === 'gpu') buildGPU();
            if (type === 'ram') buildRAM();
        }

        // --- GEOMETRIA AVAN√áADA DE VENTOINHA (OTIMIZADA) ---

        const fanGeomCache = {}; // Cache para reutilizar geometrias

        function getFanBladeGeometry(radius) {
            const key = radius.toFixed(4);
            if (fanGeomCache[key]) return fanGeomCache[key];

            console.time(`Generating Fan Geo ${key}`);
            const shape = new THREE.Shape();
            shape.moveTo(0, 0);
            shape.bezierCurveTo(radius * 0.2, radius * 0.1, radius * 0.5, radius * 0.4, radius, radius * 0.3);
            shape.bezierCurveTo(radius * 0.9, radius * 0.6, radius * 0.4, radius * 0.5, 0, 0.1);

            const extrudeSettings = {
                steps: 2, depth: 0.002, bevelEnabled: true, bevelThickness: 0.0005, bevelSize: 0.0005, bevelSegments: 2
            };

            const geo = new THREE.ExtrudeGeometry(shape, extrudeSettings);
            geo.translate(0, -0.05 * radius, 0);
            geo.rotateX(0.2);

            fanGeomCache[key] = geo;
            console.timeEnd(`Generating Fan Geo ${key}`);
            return geo;
        }

        function createFanAssembly(radius, bladeCount, colorMat) {
            const group = new THREE.Group();
            const hubRadius = radius * 0.25;

            // Hub Central
            const hub = new THREE.Mesh(new THREE.CylinderGeometry(hubRadius, hubRadius, 0.008, 32), mats.blackPlastic);
            hub.rotation.x = Math.PI / 2;
            group.add(hub);

            // Sticker Hologr√°fico (Asset)
            const sticker = new THREE.Mesh(new THREE.CircleGeometry(hubRadius * 0.8, 32), mats.sticker);
            sticker.position.z = 0.005;
            group.add(sticker);

            // Blades (Cached)
            const bladeGeo = getFanBladeGeometry(radius);
            for (let i = 0; i < bladeCount; i++) {
                const blade = new THREE.Mesh(bladeGeo, colorMat);
                const pivot = new THREE.Group();
                pivot.rotation.z = (i / bladeCount) * Math.PI * 2;
                pivot.add(blade);
                group.add(pivot);
            }
            return group;
        }

        // --- MODELOS ---

        function buildMobo() {
            const g = new THREE.Group();
            const pcb = new THREE.Mesh(new RoundedBoxGeometry(0.24, 0.004, 0.30, 4, 0.005), mats.pcb);
            pcb.receiveShadow = true; g.add(pcb);

            // Heatsinks
            const vrm1 = new THREE.Mesh(new RoundedBoxGeometry(0.04, 0.03, 0.14, 2, 0.002), mats.metal);
            vrm1.position.set(-0.08, 0.015, -0.05); g.add(vrm1);
            const vrmStrip = new THREE.Mesh(new THREE.BoxGeometry(0.041, 0.004, 0.12), mats.rgbH);
            vrmStrip.position.set(-0.08, 0.031, -0.05); g.add(vrmStrip);

            const vrm2 = new THREE.Mesh(new RoundedBoxGeometry(0.14, 0.03, 0.04, 2, 0.002), mats.metal);
            vrm2.position.set(0, 0.015, -0.10); g.add(vrm2);

            // Chipset
            const chipset = new THREE.Mesh(new RoundedBoxGeometry(0.08, 0.01, 0.08, 4, 0.005), mats.metal);
            chipset.position.set(0.05, 0.01, 0.08); g.add(chipset);
            const eye = new THREE.Mesh(new THREE.PlaneGeometry(0.05, 0.05), mats.rgbH);
            eye.rotation.x = -Math.PI / 2; eye.position.set(0.05, 0.016, 0.08); g.add(eye);

            // Slots & Details
            for (let i = 0; i < 3; i++) {
                const s = new THREE.Mesh(new THREE.BoxGeometry(0.16, 0.008, 0.012), mats.metal);
                s.position.set(0.01, 0.006, 0.04 + (i * 0.06)); g.add(s);
            }

            // Capacitors (Gold)
            const capGeo = new THREE.CylinderGeometry(0.003, 0.003, 0.008, 16);
            const capMat = new THREE.MeshStandardMaterial({ color: 0xffcc00, roughness: 0.2, metalness: 1.0 });
            for (let i = 0; i < 8; i++) {
                const c = new THREE.Mesh(capGeo, capMat);
                c.position.set(-0.06, 0.006, 0.05 + (i * 0.015));
                g.add(c);
            }
            g.position.y = 0.05; contentGroup.add(g);
        }

        function buildCPU_Cooler() {
            const g = new THREE.Group();

            // Heatsink Tower (Black Fins)
            const tower = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.14, 0.06), mats.fins);
            tower.position.y = 0.07; g.add(tower);

            // Heatpipes (Copper)
            for (let i = 0; i < 4; i++) {
                const pipe = new THREE.Mesh(new THREE.CylinderGeometry(0.003, 0.003, 0.14, 16), mats.copper);
                pipe.position.set(-0.04 + i * 0.026, 0.07, 0);
                g.add(pipe);
            }

            // Fan Frame
            const frame = new THREE.Mesh(new RoundedBoxGeometry(0.125, 0.125, 0.03, 4, 0.005), mats.blackPlastic);
            frame.position.set(0, 0.07, 0.045); g.add(frame);

            // RGB Ring (Torus)
            const ring = new THREE.Mesh(new THREE.TorusGeometry(0.055, 0.002, 16, 64), mats.rgbH);
            ring.position.set(0, 0.07, 0.061);
            g.add(ring);

            // Fan Assembly (Inside Ring)
            const fan = createFanAssembly(0.052, 9, mats.fanBladeBlack);
            fan.position.set(0, 0.07, 0.045);
            fans.push(fan); g.add(fan);

            g.position.y = 0.05; contentGroup.add(g);
        }

        function buildGPU() {
            const g = new THREE.Group();

            // PCB
            const pcb = new THREE.Mesh(new THREE.BoxGeometry(0.28, 0.004, 0.12), mats.pcb);
            g.add(pcb);

            // Heatsink (Visible Depth)
            const heatsink = new THREE.Mesh(new THREE.BoxGeometry(0.27, 0.03, 0.11), mats.fins);
            heatsink.position.y = -0.02; g.add(heatsink);

            // Shroud (White Armor)
            const shroud = new THREE.Mesh(new RoundedBoxGeometry(0.29, 0.015, 0.13, 4, 0.005), mats.whitePlastic);
            shroud.position.y = -0.045; g.add(shroud);

            // Backplate (Metal)
            const backplate = new THREE.Mesh(new THREE.BoxGeometry(0.28, 0.002, 0.12), mats.metal);
            backplate.position.y = 0.004; g.add(backplate);

            // Fans (3x Smaller, Recessed)
            for (let i = -1; i <= 1; i++) {
                const fan = createFanAssembly(0.038, 11, mats.fanBlade);
                fan.position.set(i * 0.09, -0.045, 0.066); // Recessed
                fan.rotation.x = -Math.PI / 2;
                fans.push(fan); g.add(fan);

                // Chrome Ring
                const ring = new THREE.Mesh(new THREE.TorusGeometry(0.042, 0.001, 16, 32), mats.metal);
                ring.position.set(i * 0.09, -0.045, 0.066);
                ring.rotation.x = -Math.PI / 2;
                g.add(ring);
            }

            // RGB Strip Side
            const strip = new THREE.Mesh(new THREE.BoxGeometry(0.28, 0.005, 0.005), mats.rgbH);
            strip.position.set(0, -0.02, 0.065); g.add(strip);

            g.position.y = 0.15; contentGroup.add(g);
        }

        function buildRAM() {
            const g = new THREE.Group();
            for (let i = 0; i < 4; i++) {
                const stick = new THREE.Group();

                // PCB Black
                stick.add(new THREE.Mesh(new THREE.BoxGeometry(0.133, 0.035, 0.002), mats.pcb));

                // Heat Spreader (Layered)
                const heatL = new THREE.Mesh(new RoundedBoxGeometry(0.135, 0.032, 0.002, 2, 0.001), mats.blackMetal);
                heatL.position.set(0, 0.002, 0.002); stick.add(heatL);
                const heatR = new THREE.Mesh(new RoundedBoxGeometry(0.135, 0.032, 0.002, 2, 0.001), mats.blackMetal);
                heatR.position.set(0, 0.002, -0.002); stick.add(heatR);

                // RGB Bar (Top)
                const rgb = new THREE.Mesh(new RoundedBoxGeometry(0.135, 0.008, 0.006, 2, 0.002), mats.rgbH);
                rgb.position.y = 0.022; stick.add(rgb);

                stick.position.z = i * 0.01; g.add(stick);
            }
            g.position.y = 0.05; contentGroup.add(g);
        }

        function onSelect() {
            if (reticle.visible) {
                const p = new THREE.Vector3(); camera.getWorldPosition(p);
                contentGroup.position.setFromMatrixPosition(reticle.matrix);
                if (Math.abs(p.x - contentGroup.position.x) > 0.01) contentGroup.lookAt(p.x, contentGroup.position.y, p.z);
                contentGroup.visible = true; objectPlaced = true;
                document.getElementById('ar-guide').innerText = "OBJETO FIXADO";
                setTimeout(() => document.getElementById('ar-guide').style.display = 'none', 2000);
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render(timestamp, frame) {
            const t = timestamp / 1000;
            if (frame) {
                const session = renderer.xr.getSession();
                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then(ref =>
                        session.requestHitTestSource({ space: ref }).then(source => hitTestSource = source));
                    hitTestSourceRequested = true;
                }
                if (hitTestSource) {
                    const hits = frame.getHitTestResults(hitTestSource);
                    if (hits.length > 0) {
                        reticle.visible = true;
                        reticle.matrix.fromArray(hits[0].getPose(renderer.xr.getReferenceSpace()).transform.matrix);
                        if (!objectPlaced) document.getElementById('ar-guide').innerText = "TOQUE PARA POSICIONAR";
                    } else reticle.visible = false;
                }
            }
            if (contentGroup.visible || !renderer.xr.isPresenting) {
                // SPIN FANS
                fans.forEach(f => f.rotation.z -= 0.15);
                if (rgbTextureH) rgbTextureH.offset.x -= 0.01;
            }
            renderer.render(scene, camera);
        }
    </script>
</body>

</html>
